/*!
 * Chatbox forumvi version 0.1
 * 
 * Author: Zzbaivong (lelinhtinh@gmail.com}
 * Homepage: http://devs.forumvi.com
 */
function copy_user_name(e){return $messenger[0].value+=e,$messenger.focus(),!1}function my_getcookie(e){return cname=e+"=",cpos=document.cookie.indexOf(cname),-1!=cpos?(cstart=cpos+cname.length,cend=document.cookie.indexOf(";",cstart),-1==cend&&(cend=document.cookie.length),unescape(document.cookie.substring(cstart,cend))):null}function my_setcookie(e,t,a,s){expires="",domain="",a&&(expires="; expires=Wed, 1 Jan 2020 00:00:00 GMT"),s||(s="/"),document.cookie=e+"="+t+"; path="+s+expires+domain+";"}var firstTime=!0,$wrap=$("#chatbox-wrap"),$messenger=$("#chatbox-messenger-input"),$form=$("#chatbox-form"),uId,uName,autoRefresh,$title=$("title"),regexpPM=/^(<span style="color: (#[0-9A-Fa-f]{6}|rgb\(\d{2,3}, \d{2,3}, \d{2,3}\));?">(<(strike|i|u|strong)>)*)(\d{13,}_\d+)({.*})(\["[^"]+"(\,"[^"]+")+\])(.*)$/,lastMess,userOnline=function(e){return $("#chatbox-members").find("a[onclick=\"return copy_user_name('"+e+"');\"]")},chatbox_old_update=0,oldMessage,newMessage=function(e){if(e){var t=$.parseHTML(e);$.each(t,function(){var a=$(this),s=$(".msg",a),o=s.html();if(regexpPM.test(o)){var n=o.match(regexpPM),i=JSON.parse(n[7]),c=$.inArray(encodeURIComponent(uName),i);if(-1!==c){var r=n[5],h=$('.chatbox-content[data-id="'+r+'"]'),l=$('.chatbox-change[data-id="'+r+'"]');if(l.length)l.is(":hidden")&&-1===s.text().indexOf("]/out")&&(l.show(),userOnline(l.find("h3").text()).parent().hide());else{h=$("<div>",{"class":"chatbox-content","data-id":r,style:"display: none;"}).appendTo("#chatbox-wrap");var d=n[6].slice(1,-1);if(""===d)if(d=$.grep(i,function(e){return e!==encodeURIComponent(uName)}),1===d.length){d=decodeURIComponent(d[0]);var u=userOnline(d);u.parent().hide()}else d=decodeURIComponent(d.join(", "));l=$("<div>",{"class":"chatbox-change","data-id":r,"data-name":n[6],"data-users":n[7],html:'<h3 style="color:'+u.css("color")+'">'+d+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list")}s.html(n[1]+n[9]),a.appendTo(h)}}else a.appendTo('.chatbox-content[data-id="publish"]');var f=a.closest(".chatbox-content").attr("data-id"),m=$(".chatbox-change[data-id='"+f+"']");if(o=s.text(),"/buzz"===o)s.html('<img src="http://i.imgur.com/9GvQ6Gd.gif" width="62" height="16" />'),firstTime||"0px"===$("#chatbox-main").css("left")||(m.click(),$("#chatbox-forumvi").addClass("chatbox-buzz"),$("#chatbox-buzz-audio")[0].play(),setTimeout(function(){$("#chatbox-forumvi").removeClass("chatbox-buzz"),$messenger.focus()},1e3));else if(0===o.indexOf("/out")&&"publish"!==f)if(a.find(".user > a").text()===uName){m.add(".chatbox-content[data-id='"+f+"']").hide();var b=decodeURIComponent($.grep(m.data("users"),function(e){return e!==encodeURIComponent(uName)})[0]);userOnline(b).parent().show(),my_getcookie("chatbox_active")===f&&($(".chatbox-change[data-id='publish']").click(),my_setcookie("chatbox_active",f)),a.replaceWith('<p class="chatbox-userout me clearfix">Bạn đã rời khỏi phòng.</p>')}else a.replaceWith('<p class="chatbox-userout clearfix"><strong>'+a.find(".user > a").text()+"</strong> đã rời khỏi phòng.</p>");var x=$(".date-and-time",a),v=x.text(),g=v.match(/\[(\S+)\s(\S+)\]/);x.text("["+g[1]+"]"),a.closest(".chatbox-content").find(".chatbox-date:contains('"+g[2]+"')").length||a.before('<p class="chatbox-date clearfix">'+g[2]+"</p>")}),setTimeout(function(){var e=$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]');e.length&&e.is(":visible")&&$('.chatbox-change[data-id="'+my_getcookie("chatbox_active")+'"]').click()},200);var a=JSON.parse(sessionStorage.getItem("messCounter")),s=0;if($(".chatbox-content").each(function(){var e=$(this),t=e.attr("data-id"),o=$(".chatbox_row_1, .chatbox_row_2",e).length,n=$(".chatbox-change[data-id='"+t+"']").find(".chatbox-change-mess"),i=o,c=0;a&&a[t]&&(c=parseInt(a[t],10)),i=o-c,0>=i?i="":(s+=i,i="<strong>"+i+"</strong>"),n.html(i)}),s>0){var o=$title.text(),n=/^\(\d+(\)\s.*$)/;o=n.test(o)?"("+s+o.match(n)[1]:"("+s+") "+o,$title.text(o)}setTimeout(function(){$wrap.scrollTop(99999)},300)}},filterMess=function(chatsource){eval(chatsource);var newChatboxMessages,thisLastMess;chatbox_messages?(thisLastMess=chatbox_messages.match(/<p class="chatbox_row_(1|2) clearfix">(?:.(?!<p class="chatbox_row_(1|2) clearfix">))*<\/p>$/)[0],void 0===lastMess?(newChatboxMessages=chatbox_messages,lastMess=thisLastMess,newMessage(newChatboxMessages)):lastMess!==thisLastMess&&(newChatboxMessages=chatbox_messages.split(lastMess)[1],lastMess=thisLastMess,newMessage(newChatboxMessages))):lastMess=void 0,$("#chatbox-forumvi:hidden").fadeIn(300),firstTime=!1},quickAction=function(e,t,a,s){a=a?" "+a:"",$("<li>",{"class":"chatbox-action","data-action":"/"+t+a,text:s}).appendTo(e)},menuActionOne=!0,getDone=function(e){return 0===e.indexOf("<!DOCTYPE html PUBLIC")?(alert(-1!==e.indexOf("You have been banned from the ChatBox")?"Bạn đã bị cấm truy cập chatbox!":"Mất kết nối đến máy chủ. Vui lòng đăng nhập lại!"),clearInterval(autoRefresh),!1):($("#chatbox-members").html(chatbox_memberlist),$("a","#chatbox-members").each(function(){var e=$(this),t=e.attr("oncontextmenu").split(/\(|,|\)/);e.removeAttr("oncontextmenu");{var a=t[1],s=t[2].slice(1,-1),o=t[3],n=t[4],i=t[5],c=t[6],r=t[7];t[8],t[9]}if($(".chatbox-change > h3").each(function(){var t=$(this);return t.text()==s&&t.parent().is(":visible")?(e.parent().hide(),!1):void 0}),a===o)uId=o,uName=s,$("#chatbox-me > h2").html('<a href="/u'+a+'" target="_blank" style="color:'+e.find("span").css("color")+'">'+uName+"</a>"),e.parent().remove(),menuActionOne&&(quickAction("#chatbox-title ul","out",!1,"Rời khỏi phòng"),menuActionOne=!1);else{var d=$("<div>").addClass("chatbox-setting");d.insertAfter(e);var u=$("<ul>").addClass("chatbox-dropdown");u.appendTo(d),quickAction(u,"chat",s,"Trò chuyện riêng"),2==n&&(2!=c&&quickAction(u,"ban",s,"Cấm truy cập chat"),1==i&&2==c&&1!=r?quickAction(u,"unmod",s,"Xóa quyền quản lý"):1==i&&2!=c&&quickAction(u,"mod",s,"Thăng cấp quản lý"))}}),$(".chatbox-change > h3").each(function(){var a,e=$(this),t=$("#chatbox-members").find("a[onclick=\"return copy_user_name('"+e.text()+"');\"]").closest("ul").prev("h4");t.hasClass("online")?a="online":t.hasClass("away")&&(a="away"),e.parent().removeClass("online away").addClass(a)}),filterMess(e),void 0)},update=function(e){$.get(e).done(function(e){getDone(e)}).fail(function(t){0===t.responseText.indexOf("document.getElementById('refresh_auto')")?$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:""}).done(function(){$.get(e).done(function(e){getDone(e)})}):clearInterval(autoRefresh)})},autoUpdate=function(){autoRefresh=setInterval(function(){update("/chatbox/chatbox_actions.forum?archives=1&mode=refresh")},5e3)};update("/chatbox/chatbox_actions.forum?archives=1"),autoUpdate(),$messenger.on("focus click keydown",function(){var e=$messenger.attr("data-id"),t=$(".chatbox-change[data-id='"+e+"']").find(".chatbox-change-mess"),a=parseInt(t.text(),10);if(a){var s=$(".chatbox-content[data-id='"+e+"']"),o=JSON.parse(sessionStorage.getItem("messCounter"))||{};o[e]=$(".chatbox_row_1, .chatbox_row_2",$(".chatbox-content[data-id='"+e+"']")).length,sessionStorage.setItem("messCounter",JSON.stringify(o));var n=$("p",s).length-a-1,i=$("p:gt("+n+")",s);i.addClass("chatbox-newmess"),setTimeout(function(){i.removeClass("chatbox-newmess")},3e3),$title.text($title.text().replace(/\(\d+\)\s/,"")),t.empty()}}),$("#chatbox-list").on("click",".chatbox-change",function(){var e=$(this);$(".chatbox-change.active").removeClass("active"),e.addClass("active");var t=e.attr("data-id");$(".chatbox-content").hide(),$('.chatbox-content[data-id="'+t+'"]').show();var a="",s=$("#chatbox-title >.chatbox-setting");"publish"!==t?(a=t+e.attr("data-name")+e.attr("data-users"),s.show()):s.hide(),$form.attr("data-key",a),$messenger.attr("data-id",t),$("#chatbox-title > h2").text($("h3",e).text()),$messenger.focus(),my_setcookie("chatbox_active",t,!1),$wrap.scrollTop(99999)}),$("#chatbox-members, #chatbox-title").on("click",".chatbox-action",function(){$messenger.val($(this).attr("data-action")),$form.submit()}),$("#chatbox-hidetab").click(function(){var t,a,s,e=$(this);e.toggleClass(function(){e.hasClass("show")?(t=-270,a=0,s="hide"):(t=0,a=270,s="show"),$("#chatbox-tabs").css("left",t),$("#chatbox-main").css("left",a),my_setcookie("chatbox_tabs",s,!1)})}),"hide"===my_getcookie("chatbox_tabs")&&$("#chatbox-hidetab").click(),$("#chatbox-option-buzz").click(function(){"BUZZ"===$(this).html()&&($messenger.val("/buzz"),$form.submit())});var sendMessage=function(e){oldMessage=$messenger.val(),$.post("/chatbox/chatbox_actions.forum?archives=1",{mode:"send",sent:e,sbold:$("#chatbox-input-bold").val(),sitalic:$("#chatbox-input-italic").val(),sunderline:$("#chatbox-input-underline").val(),sstrike:$("#chatbox-input-strike").val(),scolor:$("#chatbox-input-color").val()}).done(function(){$.get("/chatbox/chatbox_actions.forum?archives=1&mode=refresh").done(function(e){getDone(e),$messenger.focus()})}).fail(function(){alert("Lỗi! Tin nhắn chưa được gửi."),$messenger.val(oldMessage)})};$form.submit(function(e){e.preventDefault();var t=$messenger.val();if(""!==$.trim(t)){var a=/^\/(chat|gift|toggle|kick|ban|unban|mod|unmod|cls|clear|me)(\s(.+))?$/;if(a.test(t)){var s=t.match(a),o=s[1],n=s[3],i=encodeURIComponent(n),c=encodeURIComponent(uName);if(/^(chat|gift|toggle)$/.test(o))if("chat"===o){var h=(decodeURIComponent(n),$('.chatbox-change[data-users="[\\"'+c+'\\",\\"'+i+'\\"]"]'));h.length||(h=$('.chatbox-change[data-users="[\\"'+i+'\\",\\"'+c+'\\"]"]'));var l=userOnline(n);if(h.length)h.show().click();else if(l.length){if(l.parent().hide(),!h.length){var u,d=(new Date).getTime()+"_"+uId,f=l.parent().parent().prev("h4");u=f.hasClass("online")?" online":f.hasClass("online")?" away":"",h=$("<div>",{"class":"chatbox-change"+u,"data-id":d,"data-name":"{}","data-users":'["'+c+'","'+i+'"]',html:'<h3 style="color:'+l.css("color")+'">'+n+'</h3><span class="chatbox-change-mess"></span>'}).appendTo("#chatbox-list"),h.click(),$("<div>",{"class":"chatbox-content","data-id":d,style:"display: none;"}).appendTo($wrap)}}else h.length?h.removeClass("online away").click():alert(n===uName?"Phát hiện nghi vấn Tự kỷ ^^~":"Thành viên "+n+" hiện không truy cập!")}else"toggle"===o&&$("#chatbox-hidetab").click();else sendMessage(t)}else{var m=$form.attr("data-key")+t,b=$messenger.attr("data-id");if("/buzz"==t){var x=$("#chatbox-option-buzz");if("BUZZ"===x.html()){var g,v=59;sendMessage(m),x.addClass("disable"),x.html(60),g=setInterval(function(){var e=v--;x.html(e),0>=e&&(clearInterval(g),x.removeClass("disable"),v=59,g=void 0,x.html("BUZZ"))},1e3)}}else sendMessage("/out"==t&&"publish"!==b?m:m)}$messenger.val("")}});var chooseColor=function(e){$("#chatbox-option-color").css("background","#"+e).text("#"+e),$("#chatbox-input-color").val(e),$("#chatbox-messenger").css("color","#"+e)};$("#chatbox-option-color").click(function(){var e=Math.floor(16777215*Math.random()).toString(16);chooseColor(e),my_setcookie("optionColor",e,!1)});var cookieColor=my_getcookie("optionColor");cookieColor&&chooseColor(cookieColor),$("#chatbox-option-bold, #chatbox-option-italic, #chatbox-option-underline, #chatbox-option-strike").click(function(){var e=$(this);e.toggleClass(function(){var t="1";return e.hasClass("active")&&(t="0"),$("#"+this.id.replace("option","input")).val(t),"active"});var t=[],a="";$("#chatbox-form > input:not(#chatbox-input-color)").each(function(e){var o=this.value;if(t.push(o),"0"!==o)switch(e){case 0:a+="font-weight: bold;";break;case 1:a+="font-style: italic;";break;case 2:a+="text-decoration: underline;";break;case 3:a+="text-decoration: line-through;"}}),$messenger.attr("style",a),my_setcookie("optionCookie",t.join("|"),!0)});var getArrCookie=my_getcookie("optionCookie");getArrCookie&&$.each(getArrCookie.split("|"),function(e,t){"1"===t&&$("#chatbox-option > div").eq(e).click()});